---
- include_vars:
    file: vars/{{ ansible_distribution }}.yml

# By default, selinux on centos/7 will disallow the httpd to connect to
# cpauth (localhost:8080) You can see it in /var/log/nginx/error.log as
# '... [crit] 16897#0: *10 connect() to 127.0.0.1:8080 failed (13:
# Permission denied) while connecting to upstream ...'
- name: Set selinux into 'permissive' mode.
  selinux: policy=targeted state=permissive
  when: ansible_distribution == 'CentOS'

- name: Install NGINX
  package:
    name=nginx state=present

- name: Add mitigation for systemd/nginx race-condition
  block:
    - name: Create systemd override directory for nginx
      file:
        path: /etc/systemd/system/nginx.service.d
        state: directory
    - name: Add nginx override file
      copy:
        content: |
          # https://bugs.launchpad.net/ubuntu/+source/nginx/+bug/1581864
          [Service]
          ExecStartPost=/bin/sleep 0.1
        dest: /etc/systemd/system/nginx.service.d/override.conf
      notify: reload systemd config

- name: Start NGINX
  service:
    name=nginx state=started

- name: Install nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
  notify: reload nginx config

- include_tasks: conf.yml
  loop: "{{ extra_configs }}"
  loop_control:
    loop_var: nginx_conf_name

- name: Copy nginx SSL files (this operation is slow)
  copy: src=files/ssl/ dest=/etc/nginx/ssl/ owner=root group=root mode=0700
  notify: reload nginx config

- name: Copy nginx conf folder
  copy: >-
    src=files/conf/ dest=/etc/nginx/conf/ mode=0770
    group="{{nginx_user}}" owner="{{nginx_user}}"
  notify: reload nginx config

- name: Allowing inbound HTTP/HTTPS (CentOS)
  firewalld: service={{ item }} permanent=true state=enabled immediate=true
  with_items: [http, https]
  when: ansible_distribution == "CentOS"

- name: Allowing inbound HTTP/HTTPS (Ubuntu)
  ufw: rule=allow port={{ item }}
  with_items: [http, https]
  when: ansible_distribution == "Ubuntu"
